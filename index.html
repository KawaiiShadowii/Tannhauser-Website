<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Ei Ei Mun! - tannhauser.moe</title>
        <meta name="author" content="Kawaii Shadowii"/>
        <meta name="description" content="The website for Matikane Tannhäuser, the cutest Uma Musume out there."/>
        <meta name="keywords" content="uma,musume,uma musume,matikane,tannhäuser,matikane tannhäuser,tannhauser,matikane tannhauser,uma musume pretty derby,pretty,derby,pretty derby,ウマ娘,ウマ娘プリティーダービー,プリティーダービー,マチカネ,タンホイザ,マチカネタンホイザ"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1"/>
        <meta property="og:title" content="Ei Ei Mun! - tannhauser.moe"/>
        <meta property="og:description" content="The website for Matikane Tannhäuser, the cutest Uma Musume out there."/>
        <meta property="og:type" content="website"/>
        <meta property="og:url" content="https://www.tannhauser.moe/"/>
        <meta property="og:image" content="https://www.tannhauser.moe//img/TannhauserHappy.png"/>
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="Ei Ei Mun! - tannhauser.moe"/>
        <meta name="twitter:description" content="The website for Matikane Tannhäuser, the cutest Uma Musume out there."/>
        <meta name="twitter:image" content="https://www.tannhauser.moe//img/TannhauserHappy.png"/>
        <link rel="stylesheet" href="style.css" type="text/css"/>
        <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
        <link rel="canonical" href="https://www.tannhauser.moe/"/>
        <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    </head>
    <body>
        <img src="img/ChibiTannhauser1.png" class="preload">
        <img src="img/ChibiTannhauser2.png" class="preload">
        <div class="content">
            <h1>Welcome to tannhauser.moe</h1>
            <hr class="subtitle-seperator">
            <h2>The website for Matikane Tannhäuser, the cutest Uma Musume out there.</h2>
            <div class="counter-container">
                <p>The mun~ has been squished</p>
                <p class="counter">0</p>
                <p>times</p>
                <button class="counter-button" onclick="counterClick()">Squish the mun~!</button>
            </div>
            <h2 class="gallery-title">Machitan Photo Gallery</h2>
            <hr>
            <div class="grid">
                <noscript>Your browser does not support JavaScript or JavaScript has been disabled.<br>This website relies on JavaScript, so please enable it or use another browser.</noscript>
            </div>
        </div>
        <div class="footer">
            <p>If you have any suggestions in terms of features/images (including source), don't hesitate to contact me on Discord at <strong>Kawaii Shadowii#4571</strong></p>
        </div>        
        <script type="text/javascript">
            var counter = 0;
            var lastSecondCounter = 0;
            var temporaryCounter = 0;
            var firstSquish = true;

            var grid_element = document.querySelector(".grid");
            var msnry;

            function counterClick() {
                var counterElement = document.getElementsByClassName("counter")[0];                
                lastSecondCounter += 1;
                counterElement.textContent = (counter + lastSecondCounter + temporaryCounter).toLocaleString();             

                playMun();
                animateTannhauser();
            }

            function playMun() {
                var audio;

                if (firstSquish) {
                    firstSquish = false;
                    audio = new Audio("audio/ganbaru.mp3");
                } else {
                    var random = Math.floor(Math.random() * 10) + 1;
                    audio = new Audio("audio/mun".concat(random, ".mp3"));
                }
                
                audio.play();
            }

            function animateTannhauser() {
                var counter_button = document.getElementsByClassName("counter-button")[0];
                var id = null;

                var random = Math.floor(Math.random() * 2) + 1;
                var elem = document.createElement("img");
                elem.setAttribute("src", "img/ChibiTannhauser".concat(random, ".png"));
                elem.style.position = "absolute";
                elem.style.right = "-256px";
                elem.style.top = counter_button.getClientRects()[0].bottom + scrollY - 256 + "px"
                elem.style.zIndex = "-1";
                document.body.appendChild(elem);

                var pos = -256;
                var limit = window.innerWidth + 256;
                clearInterval(id);
                id = setInterval(frame, 10);
                function frame() {
                    if (pos >= limit) {
                    clearInterval(id);
                    elem.remove()
                    } else {
                    pos += 20;
                    elem.style.right = pos + 'px'; 
                    }
                }
            }

            function squishMuns() {
                var counterElement = document.getElementsByClassName("counter")[0];
                
                var req = new XMLHttpRequest();
                req.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = JSON.parse(this.responseText);
                        counter = data.muns;
                        temporaryCounter = 0;
                        counterElement.textContent = (counter + lastSecondCounter).toLocaleString();
                    }
                }

                req.open("POST", "https://umapyoi.net/api/v1/mun");
                var bodyString = JSON.stringify({"muns": lastSecondCounter})
                temporaryCounter = lastSecondCounter;
                lastSecondCounter = 0;
                req.send(bodyString);

                setTimeout(squishMuns, 1000)
            }

            function autorun() {
                squishMuns();
                loadImages();
                removePreloads();
            }

            function loadImages() {
                var req = new XMLHttpRequest();
                req.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var data = JSON.parse(this.responseText);
                        data = data.sort(() => Math.random() - 0.5)

                        for (let i = 0; i < data.length; i++) {
                            var entry = data[i];
                            
                            twitter_link = document.createElement("a");
                            twitter_link.setAttribute("href", entry.link);
                            twitter_link.setAttribute("target", "_blank");
                            twitter_link.classList.add("twitter-link");
                            twitter_link.classList.add("grid-item");

                            twitter_img = document.createElement("img");
                            twitter_img.setAttribute("src", entry.img);
                            twitter_img.setAttribute("class", "twitter-img");
                            twitter_img.setAttribute("alt", "");
                            twitter_img.setAttribute("loading", "lazy");
                            twitter_img.addEventListener("load", function() {
                                msnry.layout();
                            });

                            twitter_link.appendChild(twitter_img);
                            grid_element.appendChild(twitter_link);
                        }

                        msnry = new Masonry( grid_element, {
                            itemSelector: '.grid-item',
                            percentPosition: true
                        });
                    }                                
                }

                req.open("GET", "images.json");
                req.send();  
            }

            function removePreloads() {
                var preloads = [...document.getElementsByClassName("preload")]; // What the mun~ is this???

                for (const preload of preloads) {
                    document.body.removeChild(preload);
                }
            }

            window.onload = autorun();
        </script>
    </body>
</html>